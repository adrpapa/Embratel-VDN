<!DOCTYPE html>
<html>
<head>
    <script src="/aps/2/ui/runtime/client/aps/aps.js"></script>
    <script>
        require([
                "aps/ResourceStore",
                "dijit/registry",
                "dojo/when",
                "dojox/mvc/getPlainValue",
                "dojox/mvc/at",
                "dojox/mvc/getStateful",
                "aps/load",
                "aps/PageContainer",
                "aps/Memory",
                "./js/displayError.js",
                "dojo/text!./json/constants.json",
                "aps/ready!"
        ], function (Store, registry, when, getPlainValue, at, getStateful, load, PageContainer, Memory, displayError, consts) {
            var store = new Store({
                    target: "/aps/2/resources"
                }),
                model;
                var constants = JSON.parse(consts);
            /* Getting Job properties */
            store.get(aps.context.vars.cdnl.aps.id).then(function(object){
                /* Collect the Job properties in the model */
                model = getStateful(object);
                
                /* and create the widgets */
                var widgets =["aps/PageContainer", { id: "page" }, [
                         ["aps/FieldSet", { title: _("CDN Configuration")  }, []],
                         ["aps/FieldSet", { title: _("CDN Options")  }, []] ]
                ];
                widgets[2][0][2].push(["aps/TextBox", { id: "new1_cdnName",
                                label: _("Name"),
                                value: at(model, "name"),
                                disabled: true,
                                required: true,
                                size: 100,
                                placeHolder: _("[Example: This is a live event for IT free lessons]"),
                                promptMessage: _("Name of this CDN configuration. It is used to identify this configuration in your control panel"),
                                missingMessage: _("Name is mandatory. Please fill it") }]);
                widgets[2][0][2].push(["aps/TextBox", { id: "new1_alias",
                                label: _("Alias"),
                                value: at(model, "alias"),
                                disabled: true,
                                pattern: "^[a-zA-Z0-9]*$",
                                placeHolder: _("[Example: livefreelessons]"),
                                promptMessage: _("This alias will be used in the Service Routing Domain Name generated by the system"),
                                invalidMessage: _("Invalid value. It should contains only numbers and letters"),
                                required: true }]);
    
                if( model.origin_server.indexOf(constants.ORIGIN_EBT) == -1 ) {
                    widgets[2][0][2].push(["aps/TextBox", { id: "new1_origin_server",
                                label: _("Origin Server"),
                                value: at(model, "origin_server"),
                                disabled: true,
                                pattern: "^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]).)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9-]*[A-Za-z0-9])$",
                                placeHolder: _("[Examples: myhost.mydomain.com 201.233.111.10]"),
                                promptMessage: _("IP or FQDN from origin server that will provide the content"),
                                invalidMessage: _("Invalid value. It should be a valid IPv4 or FQDN"),
                                required: true }]);
                    widgets[2][0][2].push(["aps/TextBox", {
                                id: "new1_origin_path",
                                label: _("Origin Path"),
                                size: 100,
                                value: at(model, "origin_path"),
                                disabled: true,
                                pattern: "^[^\/][a-zA-Z0-9\/_-]*[^\\*:|\"<>?&\/]$",
                                placeHolder: _("[Example: out/u/myvideos]"),
                                invalidMessage: _("Invalid value. It should be a valid path. Ex: out/u"),
                                promptMessage: _("This is the path from content origin. It is used to redefine the CDN URL. It will supress the needed to type this path before the video name in the URL"),
                                required: true }]);
                }

                widgets[2][0][2].push(["aps/TextArea", {
                                id: "new1_description",
                                label: _("Description"),
                                disabled: true,
                                rows: 4,
                                cols: 60,
                                value: at(model, "description") }]);
                widgets[2][0][2].push(["aps/Output", {
                                id: "new1_origin_domain",
                                label: _("Service Routing Domain Name"),
                                value: at(model, "origin_domain")}]);
                widgets[2][1][2].push(["aps/Output", {
                                label: _("HTTPS Delivery"),
                                value: at(model, "https") }]);
                widgets[2][1][2].push(["aps/Output", {
                                label: _("Live Transmission"),
                                value: at(model, "live") }]);
                return load(widgets);
            }).then(function(){
                /* Once the widgets are created, create handlers for the navigation buttons */
                aps.app.onCancel = function() {
                    aps.apsc.gotoView("cdns");
                };

                aps.app.onSubmit = function() {
                    var page = registry.byId("page");
                    if (!page.validate()) {
                        aps.apsc.cancelProcessing();
                        return;
                    }
                    when(store.put(getPlainValue(model)),
                        function() {
                            aps.apsc.gotoView("cdns");
                        },
                        displayError
                    );
            };
            }).otherwise(displayError);
        });
    </script>
</head>
<body>
</body>
</html>
