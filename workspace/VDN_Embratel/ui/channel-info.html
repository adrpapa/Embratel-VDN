<!DOCTYPE html>
<html>
<head>
    <script src="/aps/2/ui/runtime/client/aps/aps.js"></script>
    <script>
        require([
                 "aps/ResourceStore",
               "dijit/registry",
                "dojo/when",
           "dojox/mvc/getPlainValue",
           "dojox/mvc/at",
           "dojox/mvc/getStateful",
                 "aps/load",
                 "aps/PageContainer",
                 "aps/Memory",
                "./js/displayError.js",
                 "aps/xhr",
                "aps/ready!"
        ], function (Store, registry, when, getPlainValue, at, getStateful, load,
                PageContainer, Memory, displayError, xhr) {
            var store = new Store({
                    target: "/aps/2/resources"
                }),
                model;
            console.log("Refreshing channel with id = [" + aps.context.vars.chnl.aps.id + "]");
            xhr("/aps/2/resources/" + aps.context.vars.chnl.aps.id + "/updateChannelStatus",
                        {method: "GET",  handleAs: "text"} ).then(
                function() {
                    /* Getting Channel properties */
                    store.get(aps.context.vars.chnl.aps.id).then(
                        function(object){
                            /* Collect the Channel properties in the model */
                            model = getStateful(object);
                            var basename = model["cdn_routing_domain"] + "/" + model["name"];
                            var clientUri = [["aps/Output", { id: "hlsEndpoint",label: _("HLS"),value: basename + ".m3u8" }]];
                            if( model["premium"] ){
                                clientUri.push( ["aps/Output", { id: "hdsEndpoint",label: _("HDS"),value: basename + ".f4m" }] );
                                clientUri.push( ["aps/Output", { id: "mssEndpoint",label: _("MSS"),value: basename + ".ism/Manifest" }] );
                                clientUri.push( ["aps/Output", { id: "dashEndpoint",label: _("DASH"),value: basename + ".mpd" }] );
                            }

                            /* and create the widgets */
                            var widgets =
                                ["aps/PageContainer", { id: "page" }, [
                                    ["aps/FieldSet", { id: "general", title:  _("Channel Configuration")  }, [
                                        ["aps/Output", { id: "channelName", label: _("Channel Name"), value: at(model, "name") }],
                                        ["aps/Output", {
                                            id: "description",
                                            cols: 60,
                                            label: _("Description"),
                                            value: at(model, "description") }
                                        ]
                                    ]],
                                    ["aps/FieldSet", {
                                        id: "info",
                                        title:  _("Elemental Live Information")  }, [
                                            ["aps/Output", {
                                                id: "state",
                                                label: _("State"),
                                                value: at(model, "state")}
                                            ],
                                            ["aps/Output", {
                                                id: "startEncoding",
                                                label: _("Start Encoding"),
                                                value: at(model, "start_encoding_time")}
                                            ],
                                            ["aps/Output", {
                                                id: "screen_format",
                                                label: _("Screen Format"),
                                                value: at(model, "screen_format")}
                                            ],
                                            ["aps/CheckBox", {
                                                id: "dvr",
                                                disabled: true,
                                                label: _("Provide DVR Feature?"),
                                                checked: at(model, "dvr") }
                                            ],
                                            ["aps/CheckBox", {
                                                id: "https",
                                                disabled: true,
                                                label: _("Use HTTPS?"),
                                                checked: at(model, "https") }
                                            ],
                                            ["aps/CheckBox", {
                                                id: "premium",
                                                disabled: true,
                                                label: _("Premium Configuration Options?"),
                                                checked: at(model, "premium") }
                                            ],
                                            ["aps/Output", {
                                                id: "live_event_id",
                                                label: _("Live Event Id"),
                                                value: at(model, "live_event_id") }
                                            ]
                                    ]],
                                    ["aps/FieldSet", { id: "endpoints", title: _("Public Endpoints") }, clientUri]
                                ]];
                            return load(widgets);
                        }).then(
                            function(){
                            /* Once the widgets are created, create handlers for the navigation buttons */
                            aps.app.onCancel = function() {
                                aps.apsc.gotoView("channels");
                            };

                            aps.app.onSubmit =
                                function() {
                                    var page = registry.byId("page");
                                    if (!page.validate()) {
                                        aps.apsc.cancelProcessing();
                                        return;
                                    }
                                    when(store.put(getPlainValue(model)),
                                        function() {
                                            aps.apsc.gotoView("channels");
                                        },
                                        displayError
                                    );
                                };
                            }
                        ).otherwise(displayError);
                    }
                );
            });
    </script>
</head>
<body>
</body>
</html>
