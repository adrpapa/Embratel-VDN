<!DOCTYPE html>
<html>
<head>
    <script src="/aps/2/ui/runtime/client/aps/aps.js"></script>
    <script>
        require([
                 "aps/ResourceStore",
               "dijit/registry",
                "dojo/when",
           "dojox/mvc/getPlainValue",
           "dojox/mvc/at",
           "dojox/mvc/getStateful",
                 "aps/load",
                 "aps/PageContainer",
                 "aps/Memory",
                "./js/displayError.js",
                 "aps/xhr",
                "aps/ready!"
        ], function (Store, registry, when, getPlainValue, at, getStateful, load,
                PageContainer, Memory, displayError, xhr) {
            var store = new Store({
                    target: "/aps/2/resources"
                }),
                model;
            console.log("Refreshing channel with id = [" + aps.context.vars.chnl.aps.id + "]");
            xhr("/aps/2/resources/" + aps.context.vars.chnl.aps.id + "/updateChannelStatus",
                        {method: "GET",  handleAs: "text"} ).then(
                /* Getting Channel properties */
                store.get(aps.context.vars.chnl.aps.id).then(
                    function(object){
                        /* Collect the Channel properties in the model */
                        model = getStateful(object);
                        /* and create the widgets */
                        var widgets =
                            ["aps/PageContainer", { id: "page" }, [
                                ["aps/FieldSet", { id: "general", title:  "Channel Configuration"  }, [
                                    ["aps/Output", { id: "channelName", label: _("Channel Name"), value: at(model, "name") }],
                                    ["aps/Output", { id: "description", label: _("Description"), value: at(model, "description") }]
                                ]],
                                ["aps/FieldSet", { id: "info", title:  "Elemental Live Information"  }, [
                                    ["aps/Output", { id: "state", label: _("State"), value: at(model, "state")}],
                                    ["aps/Output", { id: "screen_format", label: _("Screen Format"), value: at(model, "screen_format")}],
                                    ["aps/CheckBox", { id: "dvr", disabled: true, label: _("Provide DVR Feature?"), checked: at(model, "dvr") } ],
                                    ["aps/CheckBox", { id: "https", disabled: true,label: _("Use HTTPS?"), checked: at(model, "https") } ],
                                    ["aps/CheckBox", { id: "premium", disabled: true,label: _("Premium Configuration Options?"), checked: at(model, "premium") } ],
                                    ["aps/Output", { id: "live_event_id", label: _("Live Event Id"), value: at(model, "live_event_id")}],
                                    ["aps/Output", { id: "input_URI", label: _("Input URI"), value: at(model, "input_URI")}],
                                    ["aps/Output", { id: "ouput_host", label: _("Output Host"), value: at(model, "cdn_routing_domain")}]
                                ]]
                        ]];
                        return load(widgets);
                    }).then(
                        function(){
                        /* Once the widgets are created, create handlers for the navigation buttons */
                        aps.app.onCancel = function() {
                            aps.apsc.gotoView("channels");
                        };

                        aps.app.onSubmit =
                            function() {
                                var page = registry.byId("page");
                                if (!page.validate()) {
                                    aps.apsc.cancelProcessing();
                                    return;
                                }
                                when(store.put(getPlainValue(model)),
                                    function() {
                                        aps.apsc.gotoView("channels");
                                    },
                                    displayError
                                );
                            };
                        }).otherwise(displayError)
                );
            });
    </script>
</head>
<body>
</body>
</html>
