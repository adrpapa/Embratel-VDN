<!DOCTYPE html>
<html>
<head>
    <script src="/aps/2/ui/runtime/client/aps/aps.js"></script>
    <script>
        require([
                "aps/ResourceStore",
                "dijit/registry",
                "dojo/when",
            "dojox/mvc/getPlainValue",
            "dojox/mvc/at",
            "dojox/mvc/getStateful",
                "aps/load",
                "aps/PageContainer",
                "aps/Memory",
                "./js/displayError.js",
                "aps/ready!"
        ], function (Store, registry, when, getPlainValue, at, getStateful, load, PageContainer, Memory, displayError) {
            var store = new Store({
                    target: "/aps/2/resources"
                }),
                model;
            /* Getting Job properties */
            store.get(aps.context.vars.job.aps.id).then(function(object){
                model = getStateful(object);
                /* Collect the Job properties in the model */
                /* and create the widgets */
                var widgets =
                    ["aps/PageContainer", { id: "page" }, [
                        ["aps/FieldSet",   { id: "new1_general", title:  _("Job Configuration")  }, [
                            ["aps/Output", { id: "new1_jobName", label: _("Job Name"), value: at(model, "name") }],
                            ["aps/Output", { id: "new1_description", label: _("Description"), value: at(model, "description") }],
                            ["aps/Output", { id: "new1_input_URI", label: _("Input URI"), value: at(model, "input_URI")}]
                        ]],
                        ["aps/FieldSet",   { id: "new1_info", title:  _("Elemental Server Information")  }, [
                            ["aps/Output", { id: "new1_state", label: _("State"), value: at(model, "state")}],
                            ["aps/Output", { id: "new1_screen_format", label: _("Screen Format"), value: at(model, "screen_format")}],
                            ["aps/Output", { id: "new1_job_id", label: _("Job Id"), value: at(model, "job_id")}]
//                             ["aps/Output", { id: "new1_server_node", label: _("Elemental Server Node"), value: at(model, "server_node")}],
//                             ["aps/Output", { id: "new1_profile_id", label: _("Profile ID"), value: at(model, "profile_id")}]
                        ]]
                ]];
                return load(widgets);
            }).then(function(){
                /* Once the widgets are created, create handlers for the navigation buttons */
                aps.app.onCancel = function() {
                    aps.apsc.gotoView("jobs");
                };

                aps.app.onFinish = function() {
                    aps.apsc.gotoView("jobs");
                };

                aps.app.onSubmit = function() {
                    var page = registry.byId("page");
                    if (!page.validate()) {
                        aps.apsc.cancelProcessing();
                        return;
                    }
                    when(store.put(getPlainValue(model)),
                        function() {
                            aps.apsc.gotoView("jobs");
                        },
                        displayError
                    );
                };
            }).otherwise(displayError);
        });
    }
    catch(err) {
        alert("Error in job-info.html! "+err.message);
    }
</head>
<body>
</body>
</html>
