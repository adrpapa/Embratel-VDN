<!DOCTYPE html>
<html>
<head>
    <script src="/aps/2/ui/runtime/client/aps/aps.js"></script>
    <script>
        require([
                "aps/ResourceStore",
                "aps/xhr",
                "dojo/when",
                "dijit/registry",
                "aps/load",
                "./js/displayError.js",
            "dojo/_base/array",
                "aps/ready!"
        ], function (Store, xhr, when, registry, load, displayError, arr) {
            /* Create the data store */
            var store = new Store( {
                apsType: "http://embratel.com.br/app/VDN_Embratel/job/2.0",
                target: "/aps/2/resources/" });

            /* Create widgets */
            load(["aps/PageContainer", { id: "page" }, [
                ["aps/Grid", {
                    id:                "jobl_grid",
                    store:             store,
                    selectionMode:     "multiple",
                    apsResourceViewId: "job-info",
                    columns:           [
                        { field: "job_id",       name: _("ID"),  sortable: true,
                        renderCell:
                            function(object, data){
                                var allowedStates = "|error|complete|cancelled|";
                                var currentState = "|"+object.state+"|";
                                if( allowedStates.indexOf(currentState) == -1){
                                    return "<div>"+data+"</div>";
                                }
                                else {
                                    return data;
                                }
                            }
                        },
                        { field: "name",         name: _("Name"),  filter: { title: _("Name") }, sortable: true },
                        { field: "state",        name: _("State"), filter: { title: _("State") },  sortable: true },
                        { field: "input_URI",    name: _("Input URI")}
                    ]
                }, [
                    ["aps/Toolbar", [
                        ["aps/ToolbarButton", { id: "job_new",        iconClass: "sb-add-new",        label: "New" }],
                        ["aps/ToolbarButton", { id: "job_cancel",     iconClass: "sb-cancel",         label: "Cancel",    requireSingleItem:   true }],
                        ["aps/ToolbarButton", { id: "job_delete",     iconClass: "sb-delete",         label: "Delete",    requireSingleItem:   true }],
                        ["aps/ToolbarButton", { id: "job_refresh",    iconClass: "sb-refresh",        label: "Refresh",   autoBusy:       false }]
                    ]]
                ]]
            ]]).then(function(){
                /* Once the widgets are created, create the widget processing logic */
                var grid = registry.byId("jobl_grid"),
                    page = registry.byId("page");

                /* Create a handler for the *New* button click */
                registry.byId("job_new").on("click", function() {
                    /* Start the process of creating a VPS by going to the first screen */
                    aps.apsc.gotoView("job-new-1");
                });

                registry.byId("job_refresh").on("click", function() {
                    store.query().forEach(
                        function(item){
                            console.log("Refreshing job with id = [" + item + "]");
                            when( xhr("/aps/2/resources/" + item.aps.id + "/updateJobStatus",
                                {method: "GET",  handleAs: "text"} ),
                                function(value) {
                                    console.log(value);
                                    grid.refresh();
                                },
                                function(err) {
                                    alert( _("Error refreshing job __jobname__:\n __errmsg__",
                                        {jobname: item.name, errmsg: err.message} ));
                                }
                            );
                        }
                    );
                });

                /* Create the on-click handler for the *Cancel* button
                */
                registry.byId("job_cancel").on("click",
                    function() {
                        var sel = grid.get("selectionArray");
                        /* Clear the current messages on the screen */
                        page.get("messageList").removeAll();
                        arr.forEach(sel,
                            function(contentID){
                                console.log("I'm trying to cancel job with id = [" + contentID + "]");
                                store.get(contentID).then(
                                    function(jobOri){
                                        xhr("/aps/2/resources/" + jobOri.aps.id + "/cancelJob",
                                            {method: "GET",  handleAs: "text"}).then(
                                            function(rslt) {
                                                var result=JSON.parse(rslt);
                                                if(result.result != "ok"){
                                                    alert(result.message);
                                                }
                                                grid.refresh();
                                            },
                                            function(err) {
                                                alert( _("Job __jobname__ cannot be cancelled\n__errmsg__ ",
                                                        {jobname: jobOri["name"], errmsg: err.message} ));
                                            }
                                        );
                                    }
                                );
                            }
                        );
                        this.cancel();
                    }
                );
                // Create the on-click handler for the *Delete* button
                registry.byId("job_delete").on("click", function() {
                    var self = this;
                    var sel = grid.get("selectionArray"),
                    counter = sel.length;
                    /* Clear the current messages on the screen */
                    page.get("messageList").removeAll();
                    arr.forEach(sel, function(contentID){
                        when(store.get(contentID),
                            function(job){
                                console.log("I'm trying to cancel job with id = [" + contentID + "]");
                                /* Remove the VPS from the APS controller DB */
                                when(store.remove(contentID),
                                    function(){
                                        console.log("Job with id = [" + contentID + "] removed");
                                        sel.splice(sel.indexOf(contentID),1);
                                        grid.refresh();
                                        if (--counter === 0) { self.cancel(); }
                                    },
                                    /* If failure, call the error handler */
                                    function(e){
                                        displayError(e);
                                        if (--counter === 0) { self.cancel(); }
                                    }
                                );
                            }
                        );
                    });
                });
            });
        });

</script>
</head>
<body>
</body>
</html>
