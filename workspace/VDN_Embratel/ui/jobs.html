<!DOCTYPE html>
<html>
<head>
    <script src="/aps/2/ui/runtime/client/aps/aps.js"></script>
    <script>
        require([
             "aps/ResourceStore",
             "aps/xhr",
            "dojo/when",
           "dijit/registry",
             "aps/load",
            "./js/displayError.js",
      "dojo/_base/array",
             "aps/Memory",
             "aps/ready!"
        ], function (Store, xhr, when, registry, load, displayError, arr, Memory) {
            /* Create the data store */
            var store = new Store( {
                apsType: "http://embratel.com.br/app/VDN_Embratel/job/2.0",
                target: "/aps/2/resources/"
            });

            // Create arrays for complete and pending jobs
            var completeArr=[], pendingArr=[];
            store.query().forEach(
                function(item){
                    if( item.aps.status == "aps:ready" ) {
                        completeArr.push(item);
                    } else {
                        pendingArr.push(item);
                    }
                }
            ).then( function() {
             var pendingStore = new Memory({ data: pendingArr, idProperty: "aps.id" });
             var completeStore = new Memory({ data: completeArr, idProperty: "aps.id" });
             /* Create widgets */
             load(["aps/PageContainer", { id: "page" }, [
                 ["aps/Container", { title: _("Running Jobs") }, [
                     ["aps/Grid", {
                         id:                "pendingGrid",
                         store:             pendingStore,
                         selectionMode:     "multiple",
                         columns: [
                            { field: "job_id",    name: _("ID")},
                            { field: "name",      name: _("Name")},
                            { field: "state",     name: _("State")},
                            { field: "input_URI", name: _("Input URI")}
                         ]
                     }, [
                         ["aps/Toolbar", [
                             ["aps/ToolbarButton", { id: "job_new",     iconClass: "sb-add-new", label: _("New Job") }],
                             ["aps/ToolbarButton", { id: "job_cancel",  iconClass: "sb-cancel",  label: _("Cancel"), requireItems: true}],
                             ["aps/ToolbarButton", { id: "job_delete",  iconClass: "sb-delete",  label: _("Delete")}],
                             ["aps/ToolbarButton", { id: "job_refresh", iconClass: "sb-refresh", label: _("Refresh") }]
                         ]]
                     ]]
                 ]],
                 ["aps/Container", { title: _("Complete Jobs") }, [
                     ["aps/Grid", {
                         id:                "completeGrid",
                         store:             completeStore,
                         selectionMode:     "multiple",
                         apsResourceViewId: "job-info",
                         columns:  [
                            { field: "name",         name: _("Name"), type: "resourceName"},
                            { field: "state",        name: _("State")},
                            { field: "submit_date",  name: _("Submit Time")},
                            { field: "input_URI",    name: _("Input URI")}
                         ]
                     }]
                  ]]
             ]]).then(function(){
                /* Once the widgets are created, create the widget processing logic */
                var page = registry.byId("page");

                /* Create a handler for the *New* button click */
                registry.byId("job_new").on("click", function() {
                    /* Start the process of creating a VPS by going to the first screen */
                    aps.apsc.gotoView("job-new-1");
                });

                registry.byId("job_refresh").on("click", function() {
                    pendingArr = [];
                    completeArr = [];
                    when(
                        store.query().forEach(
                            function(item){
                                console.log("Refreshing job with id = [" + item + "]");
                                when( xhr("/aps/2/resources/" + item.aps.id + "/updateJobStatus",
                                    {method: "GET",  handleAs: "text"} ),
                                    function(value) {
                                        console.log(value);
                                    },
                                    function(err) {
                                        alert( _("Error refreshing job __jobname__:\n __errmsg__",
                                            {jobname: item.name, errmsg: err.message} ));
                                    }
                                );
                            }
                        ).then( function() {
                                store.query().forEach(
                                    function(item){
                                        if( item.aps.status == "aps:ready" ) {
                                            completeArr.push(item);
                                        } else {
                                            pendingArr.push(item);
                                        }
                                    }
                                ).then( function(){
                                    registry.byId("pendingGrid").refresh();
                                    registry.byId("completeGrid").refresh();
                                    registry.byId("job_refresh").cancel();
                                  });
                            }
                        )
                    ).then( function(){
                        aps.apsc.gotoView("jobs");
                        }
                    );
                });

                /* Create the on-click handler for the *Cancel* button
                */
                registry.byId("job_cancel").on("click",
                    function() {
                        var pendingGrid = registry.byId("pendingGrid");
                        var sel = pendingGrid.get("selectionArray");
                        /* Clear the current messages on the screen */
                        page.get("messageList").removeAll();
                        arr.forEach(sel,
                            function(contentID){
                                console.log("I'm trying to cancel job with id = [" + contentID + "]");
                                store.get(contentID).then(
                                    function(jobOri){
                                        xhr("/aps/2/resources/" + jobOri.aps.id + "/cancelJob",
                                            {method: "GET",  handleAs: "text"}).then(
                                            function(rslt) {
                                                var result=JSON.parse(rslt);
                                                if(result.result != "ok"){
                                                    alert(result.message);
                                                }
                                                pendingGrid.refresh();
                                            },
                                            function(err) {
                                                alert( _("Job __jobname__ cannot be cancelled\n__errmsg__ ",
                                                        {jobname: jobOri["name"], errmsg: err.message} ));
                                            }
                                        );
                                    }
                                );
                            }
                        );
                        registry.byId("job_cancel").cancel();
                    }
                );
                // Create the on-click handler for the *Delete* button
                registry.byId("job_delete").on("click", function() {
                    var completeGrid = registry.byId("completeGrid");
                    var self = this;
                    var sel = completeGrid.get("selectionArray");
                    var counter = sel.length;
                    /* Clear the current messages on the screen */
                    page.get("messageList").removeAll();
                    arr.forEach(sel, function(contentID){
                        when(store.get(contentID),
                            function(job){
                                console.log("I'm trying to delete job with id = [" + job.job_id + "]");
                                /* Remove the VPS from the APS controller DB */
                                when(store.remove(contentID),
                                    function(){
                                        console.log("Job with id = [" + contentID + "] removed");
                                        sel.splice(sel.indexOf(contentID),1);
                                        completeGrid.refresh();
                                        if (--counter === 0) { self.cancel(); }
                                    },
                                    /* If failure, call the error handler */
                                    function(e){
                                        displayError(e);
                                        if (--counter === 0) { self.cancel(); }
                                    }
                                );
                            }
                        ).then(function(){
                                registry.byId("job_delete").cancel();
                                 aps.apsc.gotoView("jobs");
                            });
                    });
                });
            });
            });
        });

</script>
</head>
<body>
</body>
</html>
