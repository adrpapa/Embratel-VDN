<!DOCTYPE html>
<html>
<head>
    <script src="/aps/2/ui/runtime/client/aps/aps.js"></script>
    <script>
        require([
                "aps/ResourceStore",
                "dijit/registry",
                "aps/Message",
                "dojox/mvc/getPlainValue",
                "aps/WizardData",
                "dojox/mvc/at",
                "aps/load",
                "aps/Memory",
                "dojox/mvc/getStateful",
                "./js/displayError.js",
                "aps/ready!"
        ], function (Store, registry, Message, getPlainValue, wd, at, load, Memory, getStateful, displayError) {
            var cdn_new = {
                aps: { type: "http://embratel.com.br/app/VDN_Embratel/cdn/1.0" },
                name: "",
                description: "",
                alias: "",
                origin_server: "",
                origin_path: "",
                https: false,
                live : false
            };

            var displayMessage = function (message, msgType) {
                var getMessageList = registry.byId("page").get("messageList");
                getMessageList.removeAll();
                getMessageList.addChild(new Message({description: message, type: msgType}));
            };

            var store = new Store({
                apsType: "http://embratel.com.br/app/VDN_Embratel/cdn/1.0",
                //target: "/aps/2/resources/" + aps.context.vars.context.aps.id + "/jobs"
                target: "/aps/2/resources/"
            });
            
            /* Declare the data source */
            var model = typeof aps.context.params.isNew === "undefined"? cdn_new: getStateful(wd.get());
            
            /* Create widgets */
            var widgets =
                ["aps/PageContainer", { id: "page" }, [
                    ["aps/FieldSet", { id: "new_general", title:  "CDN Configuration"  }, [
                        ["aps/TextBox", { id: "new_cdnName",
                            label: _("Name"),
                            value: at(model, "name"),
                            required: true,
                            size: 100,
                            placeHolder: _("[Example: This is a live event for IT free lessons]"),
                            promptMessage: _("Name of this CDN configuration. It's used to identify this configuration in your control panel"),
                            missingMessage: _("Name is mandatory. Please fill it") }],
                        ["aps/TextBox", { id: "new_alias",
                            label: _("Alias"),
                            value: at(model, "alias"),
                            pattern: "^[a-zA-Z0-9]*$",
                            placeHolder: _("[Example: livefreelessons]"),
                            promptMessage: _("This alias will be used in the Service Routing Domain Name generated by the system"),
                            invalidMessage: _("Invalid value. It should contains only numbers and letters"),
                            required: true } ],
                        ["aps/TextBox", { id: "new_origin_server",
                            label: _("Origin Server"),
                            value: at(model, "origin_server"),
                            pattern: "^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]).)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9-]*[A-Za-z0-9])$",
                            placeHolder: _("[Examples: myhost.mydomain.com 201.233.111.10]"),
                            promptMessage: _("IP or FQDN from origin server that will provide the content"),
                            invalidMessage: _("Invalid value. It should be a valid IPv4 or FQDN"),
                            required: true } ],
                        ["aps/TextBox", { id: "new_origin_path",
                            label: _("Origin Path"),
                            size: 100,
                            value: at(model, "origin_path"),
                            pattern: "^[^\/][a-zA-Z0-9\/_-]*[^\\*:|\"<>?&\/]$",
                            placeHolder: _("[Example: out/u/myvideos]"),
                            promptMessage: _("This is the path from content origin. It is used to redefine the CDN URL. It will supress the needed to type this path before the video name in the URL"),
                            invalidMessage: _("Invalid value. It should be a valid path. Ex: out/u"),
                            required: true } ],
                        ["aps/TextArea", { id: "new_description",
                            label: _("Description"),
                            rows: 4,
                            cols: 60,
                            value: at(model, "description") } ]
                    ]],
                    ["aps/FieldSet", { id: "new_options", title:  "CDN Options"  }, [
                        ["aps/CheckBox", { id: "new_https", label: _("Use HTTPS?"), checked: at(model, "https") } ],
                        ["aps/CheckBox", { id: "new_live", label: _("Live?"), checked: at(model, "live") } ]
                    ]]
                ]];
            load(widgets).then(function(){
                /* Create handlers for the navigation buttons */
                aps.app.onCancel = function() {
                    aps.apsc.gotoView("cdns");
                };
                
                aps.app.onSubmit = function() {
                    var page = registry.byId("page");
                    if ( page.validate() ) {
                        store.put(getPlainValue(model)).then(function() {
                            aps.apsc.gotoView("cdns");
                        }).otherwise(displayError);
                    } else {
                        displayMessage(_("Required fields have to be filled"), "warning");
                        aps.apsc.cancelProcessing();
                    }
                };
            });
        }
    );
    </script>
</head>
<body>
</body>
</html>
