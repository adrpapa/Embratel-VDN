<!DOCTYPE html>
<html>
<head>
    <script src="/aps/2/ui/runtime/client/aps/aps.js"></script>
    <script>
        require([       "aps/ResourceStore",
                       "dojo/when",
                      "dijit/registry",
                        "aps/load",
                        "aps/Memory",
                  "dojox/mvc/getStateful",
                  "dojox/mvc/getPlainValue",
                        "aps/WizardData",
                       "./js/displayError.js",
                       "./js/videoparams.js",
           "dojo/text!./json/frameRates.json",
           "dojo/text!./json/videoBitRates.json",
           "dojo/text!./json/audioBitRates.json",
           "dojo/text!./json/resol4x3.json",
           "dojo/text!./json/resol16x9.json",
                        "aps/ready!"],
            function (Store, when, registry, load, Memory, getStateful, getPlainValue, wd,
                displayError, videoparams, frameRates, videoBitRates, audioBitRates,
                resol4x3, resol16x9)
            {
                "use strict";
                var model = getStateful(wd.get());
                var store = new Store({
                    apsType: "http://embratel.com.br/app/VDN_Embratel/job/2.1",
                    //target: "/aps/2/resources/" + aps.context.vars.context.aps.id + "/jobs"
                    target: "/aps/2/resources/"
                    });

                var widget = videoparams(model, "input_URI", frameRates, videoBitRates,
                    audioBitRates, resol4x3, resol16x9 );
                load(widget).then(function()
                {
                    /* Create handlers for the navigation buttons */
                    aps.app.onSubmit = function()
                    {
                        var page = registry.byId("page");
                        if (!page.validate()) {
                            aps.apsc.cancelProcessing();
                            return;
                        }
                        var newJob= {
                            aps: {
                                type: "http://embratel.com.br/app/VDN_Embratel/job/2.1"
                            },
                            inputs: [],
                            username : model.username,
                            password : model.password,
                            screen_format: model.screen_format,
                            premium: model.premium,
                            https: model.https,
                            resolutions : model.resolutions,
                            framerates : model.framerates,
                            video_bitrates : model.video_bitrates,
                            audio_bitrates : model.audio_bitrates
                        };
                        for( var ix=0; ix < model.filenames.length; ++ix){
                            newJob.inputs.push(model.protocol + model.site + "/" + model.filenames[ix].name);
                        }
                        when(store.put(getPlainValue(model)),
                            function(){ aps.apsc.gotoView("jobs"); },
                            displayError
                        );
                    };
                    aps.app.onPrev = function()
                    {
//                         aps.apsc.prev();
                        aps.apsc.gotoView("job-new-1");
                    };
                    aps.app.onCancel = function() {
                        aps.apsc.gotoView("jobs");
                    };
                });
            } // End of function
        ); // End of require
    </script>
</head>
<body>
</body>
</html>
